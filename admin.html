<!DOCTYPE html>
<html lang="en" class="bg-black text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Velozza Events (CRUD)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--accent:#d11a12;--muted:#bdbdbd}
    body{background:#050505;color:#eee;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    .glow{filter:drop-shadow(0 6px 20px rgba(209,26,18,0.25))}
  </style>
</head>
<body class="p-6 max-w-3xl mx-auto font-sans">
  <header class="text-center mb-8">
    <img src="materiaal/velozza_distressed_logo-transparant2.png" alt="Velozza" class="h-24 mx-auto glow" />
    <h1 class="mt-4 text-3xl font-bold text-[var(--accent)]">Admin Panel</h1>
  </header>

  <!-- LOGIN -->
  <div id="loginBox" class="space-y-4">
    <h2 class="text-xl font-semibold">Login</h2>
    <input type="password" id="passwordInput" placeholder="Enter admin password"
      class="w-full p-3 bg-zinc-900 border border-zinc-700 rounded" />
    <button id="loginBtn" class="px-4 py-2 bg-[var(--accent)] rounded hover:bg-red-700">Login</button>
    <p id="loginError" class="text-red-500"></p>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="hidden mt-10 space-y-6">
    <section>
      <h2 class="text-2xl font-semibold text-gray-200">Add Event</h2>
      <div class="grid grid-cols-1 gap-3 mt-4">
        <input type="date" id="eventDate" class="p-3 bg-zinc-900 border border-zinc-700 rounded" />
        <input type="text" id="eventName" placeholder="Event name" class="p-3 bg-zinc-900 border border-zinc-700 rounded" />
        <input type="text" id="eventLocation" placeholder="Location" class="p-3 bg-zinc-900 border border-zinc-700 rounded" />
        <input type="text" id="eventCity" placeholder="City" class="p-3 bg-zinc-900 border border-zinc-700 rounded" />
        <input type="text" id="eventCountry" placeholder="Country" class="p-3 bg-zinc-900 border border-zinc-700 rounded" />
        <input type="text" id="eventTime" placeholder="Time (optional)" class="p-3 bg-zinc-900 border border-zinc-700 rounded" />
        <input type="text" id="eventLink" placeholder="Ticket link (optional)" class="p-3 bg-zinc-900 border border-zinc-700 rounded" />
      </div>
      <div class="flex items-center gap-3 mt-3">
        <button id="saveEvent" class="px-4 py-2 bg-[var(--accent)] rounded hover:bg-red-700">Save Event</button>
        <div id="saveMsg" class="text-green-400"></div>
      </div>
    </section>

    <hr class="border-zinc-700" />

    <section>
      <h2 class="text-2xl font-semibold text-gray-200">Manage Events</h2>
      <div id="eventList" class="mt-4 space-y-3"></div>
    </section>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
    <div id="editCard" class="bg-zinc-900 p-6 rounded-xl w-full max-w-lg shadow-lg border border-zinc-700">
      <h3 class="text-xl font-semibold text-[var(--accent)]">Edit Event</h3>
      <div class="grid grid-cols-1 gap-3 mt-4">
        <input id="editDate" type="date" class="p-3 bg-black border border-zinc-700 rounded" />
        <input id="editName" type="text" class="p-3 bg-black border border-zinc-700 rounded" />
        <input id="editLocation" type="text" class="p-3 bg-black border border-zinc-700 rounded" />
        <input id="editCity" type="text" class="p-3 bg-black border border-zinc-700 rounded" />
        <input id="editCountry" type="text" class="p-3 bg-black border border-zinc-700 rounded" />
        <input id="editTime" type="text" class="p-3 bg-black border border-zinc-700 rounded" />
        <input id="editLink" type="text" class="p-3 bg-black border border-zinc-700 rounded" />
      </div>

      <div class="flex justify-between items-center gap-3 mt-4">
        <button id="cancelEdit" class="px-4 py-2 bg-zinc-700 rounded hover:bg-zinc-600">Cancel</button>
        <div class="flex items-center gap-2">
          <button id="deleteEdit" class="px-4 py-2 bg-red-600 rounded hover:bg-red-700">Delete</button>
          <button id="saveEdit" class="px-4 py-2 bg-[var(--accent)] rounded hover:bg-red-700">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FIREBASE + CRUD LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      doc,
      updateDoc,
      deleteDoc,
      getDoc,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAj7nzvflTuXerUQ9LzOnn7TRojw4ZHlkc",
      authDomain: "velozza-events.firebaseapp.com",
      projectId: "velozza-events",
      storageBucket: "velozza-events.firebasestorage.app",
      messagingSenderId: "125892769650",
      appId: "1:125892769650:web:81deb40d2b0a7e7bb58feb",
      measurementId: "G-HS8GCH4040"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Element refs
    const loginBox = document.getElementById('loginBox');
    const adminPanel = document.getElementById('adminPanel');
    const loginError = document.getElementById('loginError');

    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');

    const eventDate = document.getElementById('eventDate');
    const eventName = document.getElementById('eventName');
    const eventLocation = document.getElementById('eventLocation');
    const eventCity = document.getElementById('eventCity');
    const eventCountry = document.getElementById('eventCountry');
    const eventTime = document.getElementById('eventTime');
    const eventLink = document.getElementById('eventLink');
    const saveEvent = document.getElementById('saveEvent');
    const saveMsg = document.getElementById('saveMsg');

    const eventList = document.getElementById('eventList');

    const editModal = document.getElementById('editModal');
    const editCard = document.getElementById('editCard');
    const editDate = document.getElementById('editDate');
    const editName = document.getElementById('editName');
    const editLocation = document.getElementById('editLocation');
    const editCity = document.getElementById('editCity');
    const editCountry = document.getElementById('editCountry');
    const editTime = document.getElementById('editTime');
    const editLink = document.getElementById('editLink');
    const cancelEdit = document.getElementById('cancelEdit');
    const saveEdit = document.getElementById('saveEdit');
    const deleteEdit = document.getElementById('deleteEdit');

    let currentEditId = null;

    // SIMPLE PASSWORD LOGIN (you can replace with Firebase Auth later)
    loginBtn.addEventListener('click', () => {
      const pwd = passwordInput.value.trim();
      if (pwd === 'R7pX92fGq4mT8bLd') {
        loginBox.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        setupRealtimeList();
      } else {
        loginError.textContent = 'Incorrect password.';
      }
    });

    // ADD EVENT
    saveEvent.addEventListener('click', async () => {
      const date = eventDate.value;
      const name = eventName.value.trim();
      const location = eventLocation.value.trim();
      const city = eventCity.value.trim();
      const country = eventCountry.value.trim();
      const time = eventTime.value.trim();
      const link = eventLink.value.trim();

      if (!date || !name || !location) {
        saveMsg.textContent = 'Missing required fields.';
        return;
      }

      try {
        await addDoc(collection(db, 'events'), {
          date, name, location, city, country, time, link,
          createdAt: Date.now()
        });
        saveMsg.textContent = 'Event saved!';
        setTimeout(() => saveMsg.textContent = '', 2500);
        eventDate.value = eventName.value = eventLocation.value = eventCity.value = eventCountry.value = eventTime.value = eventLink.value = '';
      } catch (err) {
        console.error('Add doc error', err);
        saveMsg.textContent = 'Could not save event.';
      }
    });

    // SETUP REALTIME LISTENER
    function setupRealtimeList(){
      const q = query(collection(db, 'events'), orderBy('date', 'asc'));
      onSnapshot(q, snap => {
        eventList.innerHTML = '';
        if (snap.empty) {
          eventList.innerHTML = '<div class="text-zinc-500">No events yet.</div>';
          return;
        }

        snap.forEach(docSnap => {
          const e = { id: docSnap.id, ...docSnap.data() };
          const row = document.createElement('div');
          row.className = 'p-4 border border-zinc-700 rounded bg-zinc-900 flex justify-between items-center';

          const left = document.createElement('div');
          left.innerHTML = `<div class="font-semibold">${escapeHtml(e.name)}</div><div class="text-zinc-400 text-sm">${escapeHtml(e.date)} — ${escapeHtml(e.city || '')}${e.city && e.country? ', ': ''}${escapeHtml(e.country || '')}</div>`;

          const right = document.createElement('div');
          right.className = 'flex items-center gap-2';
          const editBtn = document.createElement('button');
          editBtn.className = 'px-3 py-1 bg-zinc-700 rounded hover:bg-zinc-600';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => openEditModal(e.id));

          const delBtn = document.createElement('button');
          delBtn.className = 'px-3 py-1 bg-red-600 rounded hover:bg-red-700';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => deleteEvent(e.id));

          right.appendChild(editBtn);
          right.appendChild(delBtn);

          row.appendChild(left);
          row.appendChild(right);

          eventList.appendChild(row);
        });
      }, err => {
        console.error('Snapshot error', err);
        eventList.innerHTML = '<div class="text-red-400">Could not load events.</div>';
      });
    }

    // OPEN EDIT MODAL
    async function openEditModal(id){
      currentEditId = id;
      try {
        const ref = doc(db, 'events', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          alert('Event not found.');
          return;
        }
        const e = snap.data();

        editDate.value = e.date || '';
        editName.value = e.name || '';
        editLocation.value = e.location || '';
        editCity.value = e.city || '';
        editCountry.value = e.country || '';
        editTime.value = e.time || '';
        editLink.value = e.link || '';

        editModal.classList.remove('hidden');
      } catch (err) {
        console.error('Open edit error', err);
        alert('Could not open event for editing.');
      }
    }

    // CLOSE EDIT MODAL
    function closeEditModal(){
      currentEditId = null;
      editModal.classList.add('hidden');
    }

    cancelEdit.addEventListener('click', closeEditModal);

    // DELETE (from modal or list)
    async function deleteEvent(id){
      const ok = confirm('Are you sure you want to delete this event?');
      if (!ok) return;
      try {
        await deleteDoc(doc(db, 'events', id));
        // if modal open for same id, close it
        if (currentEditId === id) closeEditModal();
      } catch (err) {
        console.error('Delete error', err);
        alert('Could not delete event.');
      }
    }

    deleteEdit.addEventListener('click', () => {
      if (!currentEditId) return;
      deleteEvent(currentEditId);
    });

    // SAVE EDIT
    saveEdit.addEventListener('click', async () => {
      if (!currentEditId) return;
      const payload = {
        date: editDate.value,
        name: editName.value.trim(),
        location: editLocation.value.trim(),
        city: editCity.value.trim(),
        country: editCountry.value.trim(),
        time: editTime.value.trim(),
        link: editLink.value.trim()
      };

      if (!payload.date || !payload.name || !payload.location) {
        alert('Date, name and location are required.');
        return;
      }

      try {
        await updateDoc(doc(db, 'events', currentEditId), payload);
        closeEditModal();
      } catch (err) {
        console.error('Update error', err);
        alert('Could not save changes.');
      }
    });

    // Close modal when clicking outside the card
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) closeEditModal();
    });

    // Simple helper to avoid accidental HTML injection in list display (we still trust admins)
    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function(m){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }

  </script>
</body>
</html>
